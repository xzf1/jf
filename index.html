<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JFèŠå¤©ç³»ç»Ÿ</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"     
    rel="stylesheet"
    integrity="sha384-0evHe/X+828DZkpAfEBcaAiCkVc7QVmYnEAyRFqlX85AfR8zrR4VnWKvzZ7xzkQB5"
    crossorigin="anonymous"
  />
  <style>
    /* åŸºç¡€æ ·å¼ */
    body {
      font-family: 'Arial', sans-serif;
      color: #333;
      background-color: #f7f7f7;
      padding: 0px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      transition: background-color 0.3s, color 0.3s;
    }
    
    /* æµ…è‰²ä¸»é¢˜ */
    body.theme-light {
      background-color: #f7f7f7;
      color: #333;
    }
    
    /* æ·±è‰²ä¸»é¢˜ */
    body.theme-dark {
      background-color: #1a1a1a;
      color: #f0f0f0;
    }
    
    body.theme-dark .login-container {
      background-color: #2d2d2d;
      color: #f0f0f0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    body.theme-dark .login-container h2 {
      color: #f0f0f0;
    }
    
    body.theme-dark .form-control {
      background-color: #3d3d3d;
      border: 1px solid #555;
      color: #f0f0f0;
    }
    
    body.theme-dark .form-control::placeholder {
      color: #aaa;
    }
    
    body.theme-dark .remember-me label {
      color: #f0f0f0;
    }
    
    body.theme-dark .chat-container {
      background-color: #2d2d2d;
      color: #f0f0f0;
    }
    
    body.theme-dark .chat-header {
      background-color: #3d3d3d;
      border-bottom: 1px solid #555;
    }
    
    body.theme-dark .chat-title {
      color: #f0f0f0;
    }
    
    body.theme-dark .chat-messages {
      background-color: #252525;
    }
    
    body.theme-dark .other-text {
      background-color: #3d3d3d;
      color: #f0f0f0;
    }
    
    body.theme-dark .username {
      color: #f0f0f0;
    }
    
    body.theme-dark .input-container {
      background-color: #2d2d2d;
      border-top: 1px solid #555;
    }
    
    body.theme-dark .input-field {
      background-color: #3d3d3d;
      border: 1px solid #555;
      color: #f0f0f0;
    }
    
    body.theme-dark .input-field::placeholder {
      color: #aaa;
    }
    
    body.theme-dark .settings-container {
      background-color: #2d2d2d;
      color: #f0f0f0;
    }
    
    body.theme-dark .settings-header {
      background-color: #3d3d3d;
      border-bottom: 1px solid #555;
    }
    
    body.theme-dark .settings-title {
      color: #f0f0f0;
    }
    
    body.theme-dark .settings-content {
      background-color: #252525;
    }
    
    body.theme-dark .settings-section {
      background-color: #3d3d3d;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    body.theme-dark .settings-section h3 {
      color: #f0f0f0;
    }
    
    body.theme-dark .settings-item label {
      color: #f0f0f0;
    }
    
    body.theme-dark .settings-item input,
    body.theme-dark .settings-item select {
      background-color: #4d4d4d;
      border: 1px solid #555;
      color: #f0f0f0;
    }
    
    body.theme-dark .system-message {
      color: #aaa;
    }
    
    /* å­—ä½“å¤§å°è®¾ç½® */
    body.font-small {
      font-size: 12px;
    }
    
    body.font-medium {
      font-size: 14px;
    }
    
    body.font-large {
      font-size: 16px;
    }
    
    body.font-large .chat-title,
    body.font-large .settings-title {
      font-size: 20px;
    }
    
    body.font-large .input-field,
    body.font-large .send-button,
    body.font-large .header-button {
      font-size: 16px;
    }
    
    body.font-small .chat-title,
    body.font-small .settings-title {
      font-size: 16px;
    }
    
    body.font-small .input-field,
    body.font-small .send-button,
    body.font-small .header-button {
      font-size: 12px;
    }
    
    .login-container {
      width: 100%;
      max-width: 300px;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin: 15px;
    }
    
    @media (max-width: 480px) {
      .login-container {
        padding: 25px;
        margin: 10px;
      }
      .chat-container {
        border-radius: 0;
        height: 100%;
        max-width: 100%;
      }
    }
    
    .login-form h2 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .form-control {
      border-radius: 6px;
      border: 1px solid #ddd;
      padding: 12px 20px;
      margin-top: 4px;
      margin-bottom: 20px;
      box-sizing: border-box;
    }
    
    .btn.btn-primary {
      background-color: #007bff;
      border-color: #007bff;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
    }
    
    .btn.btn-primary:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      max-width: 600px;
      margin: 0;
      background-color: #ffffff;
      border-radius: 0;
      padding: 0;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }

    .chat-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .header-buttons {
      display: flex;
      gap: 8px;
    }

    .header-button {
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .header-button:hover {
      background-color: #5a6268;
    }

    .settings-button {
      background-color: #17a2b8;
    }

    .settings-button:hover {
      background-color: #138496;
    }

    .upload-button {
      background-color: #28a745;
    }

    .upload-button:hover {
      background-color: #218838;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background-color: #f8f9fa;
    }

    .chat-message {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .own-text {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      margin-left: auto;
      max-width: 80%;
      word-break: break-word;
      line-height: 1.4;
    }

    .other-text {
      background-color: #e9ecef;
      color: #333;
      padding: 10px 15px;
      border-radius: 8px;
      margin-right: auto;
      max-width: 80%;
      word-break: break-word;
      line-height: 1.4;
    }

    .username {
      font-weight: bold;
      margin-right: 8px;
    }

    .input-container {
      display: flex;
      gap: 10px;
      padding: 15px;
      background-color: white;
      border-top: 1px solid #ddd;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }

    .input-field {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .send-button {
      flex: 0 0 20%;
      padding: 10px 5px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
    }

    @media (max-width: 480px) {
      .input-container {
        gap: 3%;
      }
      
      .input-field {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
      }
      
      .send-button {
        flex-basis: 25%;
        padding: 9px 3px;
      }
      
      .header-buttons {
        gap: 5px;
      }
      
      .header-button {
        padding: 5px 8px;
        font-size: 12px;
      }
    }
    
    #reconnectAlert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ff9800;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    #reconnectAlert.error {
      background: #f44336;
    }
    
    .system-message {
      text-align: center;
      color: #6c757d;
      font-size: 12px;
      margin: 10px 0;
      font-style: italic;
    }
    
    .remember-me {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .remember-me input {
      margin-right: 8px;
    }
    
    /* è®¾ç½®é¢æ¿æ ·å¼ */
    .settings-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      max-width: 600px;
      margin: 0;
      background-color: #ffffff;
      border-radius: 0;
      padding: 0;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
    }
    
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }
    
    .settings-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .settings-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: #f8f9fa;
    }
    
    .settings-section {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .settings-section h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 16px;
      color: #333;
    }
    
    .settings-item {
      margin-bottom: 15px;
    }
    
    .settings-item label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .settings-item input[type="text"],
    .settings-item input[type="password"],
    .settings-item select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .settings-item .checkbox {
      display: flex;
      align-items: center;
    }
    
    .settings-item .checkbox input {
      margin-right: 8px;
    }
    
    .settings-button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .settings-button-group button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-save {
      background-color: #28a745;
      color: white;
    }
    
    .btn-save:hover {
      background-color: #218838;
    }
    
    .btn-cancel {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-cancel:hover {
      background-color: #5a6268;
    }
    
    .btn-danger {
      background-color: #dc3545;
      color: white;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    .btn-logout {
      background-color: #dc3545;
      color: white;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
    
    .btn-logout:hover {
      background-color: #c82333;
    }
    
    /* URLé“¾æ¥æ ·å¼ */
    .message-link {
      color: #007bff;
      text-decoration: underline;
      cursor: pointer;
    }
    
    .message-link:hover {
      color: #0056b3;
      text-decoration: none;
    }
    
    body.theme-dark .message-link {
      color: #4da6ff;
    }
    
    body.theme-dark .message-link:hover {
      color: #80c1ff;
    }
    
    /* è§†é¢‘é“¾æ¥ç‰¹æ®Šæ ·å¼ */
    .video-link {
      color: #ff6b6b;
      font-weight: bold;
    }
    
    body.theme-dark .video-link {
      color: #ff9999;
    }
    
    /* å›¾ç‰‡é“¾æ¥ç‰¹æ®Šæ ·å¼ */
    .image-link {
      color: #28a745;
      font-weight: bold;
    }
    
    body.theme-dark .image-link {
      color: #4caf50;
    }
    
    /* æµè§ˆå™¨å®¹å™¨æ ·å¼ */
    .browser-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      max-width: 600px;
      margin: 0;
      background-color: #ffffff;
      border-radius: 0;
      padding: 0;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
    }
    
    .browser-header {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      gap: 10px;
    }
    
    .browser-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      flex: 1;
      text-align: center;
    }
    
    .browser-controls {
      display: flex;
      gap: 8px;
    }
    
    .browser-button {
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .browser-button:hover {
      background-color: #5a6268;
    }
    
    .browser-content {
      flex: 1;
      overflow: auto;
      background-color: white;
    }
    
    .browser-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    body.theme-dark .browser-container {
      background-color: #2d2d2d;
      color: #f0f0f0;
    }
    
    body.theme-dark .browser-header {
      background-color: #3d3d3d;
      border-bottom: 1px solid #555;
    }
    
    body.theme-dark .browser-title {
      color: #f0f0f0;
    }
    
    body.theme-dark .browser-content {
      background-color: #252525;
    }
    
    /* ä¸Šä¼ é¡µé¢æ ·å¼ */
    .upload-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      max-width: 600px;
      margin: 0;
      background-color: #ffffff;
      border-radius: 0;
      padding: 0;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
    }
    
    .upload-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }
    
    .upload-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .upload-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: #f8f9fa;
    }
    
    .upload-section {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .upload-section h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 16px;
      color: #333;
    }
    
    .upload-item {
      margin-bottom: 15px;
    }
    
    .upload-item label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .file-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .upload-button {
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
      margin-top: 10px;
    }
    
    .upload-button:hover {
      background-color: #218838;
    }
    
    .upload-button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    .progress-container {
      margin-top: 15px;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background-color: #007bff;
      width: 0%;
      transition: width 0.3s;
    }
    
    .progress-text {
      text-align: center;
      margin-top: 5px;
      font-size: 14px;
      color: #6c757d;
    }
    
    .file-preview {
      margin-top: 15px;
      text-align: center;
      display: none;
    }
    
    .file-preview img,
    .file-preview video {
      max-width: 100%;
      max-height: 200px;
      border-radius: 4px;
    }
    
    body.theme-dark .upload-container {
      background-color: #2d2d2d;
      color: #f0f0f0;
    }
    
    body.theme-dark .upload-header {
      background-color: #3d3d3d;
      border-bottom: 1px solid #555;
    }
    
    body.theme-dark .upload-title {
      color: #f0f0f0;
    }
    
    body.theme-dark .upload-content {
      background-color: #252525;
    }
    
    body.theme-dark .upload-section {
      background-color: #3d3d3d;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    body.theme-dark .upload-section h3 {
      color: #f0f0f0;
    }
    
    body.theme-dark .upload-item label {
      color: #f0f0f0;
    }
    
    body.theme-dark .file-input {
      background-color: #4d4d4d;
      border: 1px solid #555;
      color: #f0f0f0;
    }
    
    /* å®‰å“æ–‡ä»¶é€‰æ‹©å™¨ä¼˜åŒ– */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    
    .file-input {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-label {
      display: block;
      padding: 12px 20px;
      background-color: #007bff;
      color: white;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .file-input-label:hover {
      background-color: #0056b3;
    }
    
    .file-input-info {
      margin-top: 10px;
      font-size: 14px;
      color: #6c757d;
      text-align: center;
    }
    
    /* MP4æ’­æ”¾å™¨æ ·å¼ */
    .video-player-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      max-width: 600px;
      margin: 0;
      background-color: #000;
      border-radius: 0;
      padding: 0;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
    }
    
    .video-player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: rgba(0, 0, 0, 0.7);
      border-bottom: 1px solid #444;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }
    
    .video-player-title {
      font-size: 16px;
      font-weight: bold;
      color: white;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
    }
    
    .video-player-controls {
      display: flex;
      gap: 8px;
    }
    
    .video-player-button {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .video-player-button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .video-player-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background-color: #000;
    }
    
    .video-player {
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    .video-player-controls-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 10;
    }
    
    .video-control-button {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    
    .video-progress-container {
      flex: 1;
      height: 5px;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }
    
    .video-progress {
      height: 100%;
      background-color: #007bff;
      border-radius: 2px;
      width: 0%;
    }
    
    .video-time {
      color: white;
      font-size: 12px;
      min-width: 100px;
      text-align: center;
    }
    
    .video-volume-container {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .video-volume-slider {
      width: 60px;
      height: 5px;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }
    
    .video-volume-level {
      height: 100%;
      background-color: #007bff;
      border-radius: 2px;
      width: 100%;
    }

    /* å›¾ç‰‡æŸ¥çœ‹å™¨æ ·å¼ */
    .image-viewer-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      max-width: 600px;
      margin: 0;
      background-color: #000;
      border-radius: 0;
      padding: 0;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
    }
    
    .image-viewer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: rgba(0, 0, 0, 0.7);
      border-bottom: 1px solid #444;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }
    
    .image-viewer-title {
      font-size: 16px;
      font-weight: bold;
      color: white;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
    }
    
    .image-viewer-controls {
      display: flex;
      gap: 8px;
    }
    
    .image-viewer-button {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .image-viewer-button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .image-viewer-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background-color: #000;
      position: relative;
    }
    
    .image-viewer {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      transition: transform 0.3s;
    }
    
    .image-viewer-controls-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 10;
    }
    
    .image-control-button {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    
    .image-nav-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 18px;
      cursor: pointer;
      z-index: 5;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .image-nav-button:hover {
      background-color: rgba(0, 0, 0, 0.7);
    }
    
    .image-prev-button {
      left: 10px;
    }
    
    .image-next-button {
      right: 10px;
    }
    
    .image-counter {
      color: white;
      font-size: 14px;
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 5;
    }
  </style>
</head>
<body>
  <!-- é‡è¿æç¤ºæ¡† -->
  <div id="reconnectAlert">
    æ­£åœ¨å°è¯•è¿æ¥æœåŠ¡å™¨... (<span id="attemptCount">0</span>/5)
  </div>

  <div class="login-container" id="loginPanel">
    <h2 style="text-align: center; margin-bottom: 20px;">JFèŠå¤©è½¯ä»¶</h2>
    <input type="text" id="username" class="form-control" placeholder="ç”¨æˆ·å">
    <input type="password" id="password" class="form-control" placeholder="å¯†ç " style="margin-top: 15px;">
    <div class="remember-me">
      <input type="checkbox" id="rememberMe" checked>
      <label for="rememberMe">è®°ä½ç™»å½•çŠ¶æ€</label>
    </div>
    <button class="btn btn-primary" id="loginBtn" onclick="login()">ç™»å½•</button>
  </div>

  <div class="chat-container" id="chatPanel" style="display: none;">
    <div class="chat-header">
      <div class="chat-title">JFèŠå¤©å®¤ - <span id="currentUsername"></span></div>
      <div class="header-buttons">
        <button class="header-button settings-button" onclick="showUpload()">ä¸Šä¼ </button>
        <button class="header-button settings-button" onclick="showSettings()">è®¾ç½®</button>
      </div>
    </div>
    <div class="chat-messages" id="messageContainer"></div>
    <div class="input-container">
      <input 
        type="text" 
        class="input-field" 
        id="messageInput" 
        placeholder="è¾“å…¥æ¶ˆæ¯"
        onkeydown="if(event.key === 'Enter') { sendMessage(); event.preventDefault(); }"
      >
      <button class="send-button" onclick="sendMessage()">å‘é€</button>
    </div>
  </div>

  <!-- è®¾ç½®é¢æ¿ -->
  <div class="settings-container" id="settingsPanel" style="display: none;">
    <div class="settings-header">
      <div class="settings-title">è®¾ç½®</div>
      <div class="header-buttons">
        <button class="header-button" onclick="hideSettings()">è¿”å›</button>
      </div>
    </div>
    <div class="settings-content">
      <!-- ç•Œé¢è®¾ç½® -->
      <div class="settings-section">
        <h3>ç•Œé¢è®¾ç½®</h3>
        <div class="settings-item">
          <label for="themeSelect">ä¸»é¢˜</label>
          <select id="themeSelect">
            <option value="light">æµ…è‰²</option>
            <option value="dark">æ·±è‰²</option>
            <option value="auto">è·Ÿéšç³»ç»Ÿ</option>
          </select>
        </div>
        <div class="settings-item">
          <label for="fontSize">å­—ä½“å¤§å°</label>
          <select id="fontSize">
            <option value="small">å°</option>
            <option value="medium" selected>ä¸­</option>
            <option value="large">å¤§</option>
          </select>
        </div>
      </div>
      
      <!-- æ•°æ®ç®¡ç† -->
      <div class="settings-section">
        <h3>æ•°æ®ç®¡ç†</h3>
        <div class="settings-item">
          <p>åˆ é™¤æ‰€æœ‰æœ¬åœ°èŠå¤©è®°å½•ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
          <button class="btn-danger" onclick="confirmClearChatHistory()">åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•</button>
        </div>
      </div>
      
      <div class="settings-button-group">
        <button class="btn-cancel" onclick="hideSettings()">å–æ¶ˆ</button>
        <button class="btn-save" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
      </div>
      
      <button class="btn-logout" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <!-- ä¸Šä¼ é¢æ¿ -->
  <div class="upload-container" id="uploadPanel" style="display: none;">
    <div class="upload-header">
      <div class="upload-title">ä¸Šä¼ æ–‡ä»¶</div>
      <div class="header-buttons">
        <button class="header-button" onclick="hideUpload()">è¿”å›</button>
      </div>
    </div>
    <div class="upload-content">
      <div class="upload-section">
        <h3>é€‰æ‹©æ–‡ä»¶</h3>
        <div class="upload-item">
          <label for="fileInput">é€‰æ‹©å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶</label>
          <div class="file-input-wrapper">
            <input type="file" id="fileInput" class="file-input" accept="image/*,video/*" capture="camera">
            <div class="file-input-label">é€‰æ‹©æ–‡ä»¶</div>
          </div>
          <p class="file-input-info">æ”¯æŒæ ¼å¼: JPG, JPEG, PNG, GIF, MP4</p>
          <p class="file-input-info">æç¤º: åœ¨å®‰å“è®¾å¤‡ä¸Šï¼Œæ‚¨å¯ä»¥é€‰æ‹©"æ–‡ä»¶"ã€"ç›¸æœº"æˆ–"å›¾åº“"</p>
        </div>
        
        <div class="file-preview" id="filePreview">
          <!-- æ–‡ä»¶é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        
        <div class="progress-container" id="progressContainer">
          <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
          </div>
          <div class="progress-text" id="progressText">0%</div>
        </div>
        
        <button class="upload-button" id="uploadBtn" onclick="uploadFile()" disabled>ä¸Šä¼ æ–‡ä»¶</button>
      </div>
    </div>
  </div>

  <!-- æµè§ˆå™¨é¢æ¿ -->
  <div class="browser-container" id="browserPanel" style="display: none;">
    <div class="browser-header">
      <div class="browser-controls">
        <button class="browser-button" onclick="browserBack()">åé€€</button>
        <button class="browser-button" onclick="browserForward()">å‰è¿›</button>
        <button class="browser-button" onclick="browserReload()">åˆ·æ–°</button>
      </div>
      <div class="browser-title"></div>
      <div class="browser-controls">
        <button class="browser-button" onclick="hideBrowser()">è¿”å›èŠå¤©</button>
      </div>
    </div>
    <div class="browser-content">
      <iframe id="browserFrame" class="browser-iframe" src="about:blank"></iframe>
    </div>
  </div>

  <!-- MP4æ’­æ”¾å™¨ -->
  <div class="video-player-container" id="videoPlayerPanel" style="display: none;">
    <div class="video-player-header">
      <div class="video-player-title" id="videoPlayerTitle">è§†é¢‘æ’­æ”¾å™¨</div>
      <div class="video-player-controls">
        <button class="video-player-button" onclick="hideVideoPlayer()">è¿”å›</button>
      </div>
    </div>
    <div class="video-player-content">
      <video id="videoPlayer" class="video-player" controls>
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
      </video>
    </div>
    <div class="video-player-controls-bar" id="videoControls" style="display: none;">
      <button class="video-control-button" id="playPauseBtn">â–¶</button>
      <div class="video-progress-container" id="progressBarContainer">
        <div class="video-progress" id="videoProgress"></div>
      </div>
      <div class="video-time" id="videoTime">0:00 / 0:00</div>
      <div class="video-volume-container">
        <button class="video-control-button" id="volumeBtn">ğŸ”Š</button>
        <div class="video-volume-slider" id="volumeSlider">
          <div class="video-volume-level" id="volumeLevel"></div>
        </div>
      </div>
      <button class="video-control-button" id="fullscreenBtn">â›¶</button>
    </div>
  </div>

  <!-- å›¾ç‰‡æŸ¥çœ‹å™¨ -->
  <div class="image-viewer-container" id="imageViewerPanel" style="display: none;">
    <div class="image-viewer-header">
      <div class="image-viewer-title" id="imageViewerTitle">å›¾ç‰‡æŸ¥çœ‹å™¨</div>
      <div class="image-viewer-controls">
        <button class="image-viewer-button" onclick="hideImageViewer()">è¿”å›</button>
      </div>
    </div>
    <div class="image-viewer-content">
      <img id="imageViewer" class="image-viewer" src="" alt="å›¾ç‰‡">
      <button class="image-nav-button image-prev-button" id="prevImageBtn" onclick="prevImage()">â®</button>
      <button class="image-nav-button image-next-button" id="nextImageBtn" onclick="nextImage()">â¯</button>
      <div class="image-counter" id="imageCounter">1 / 1</div>
    </div>
    <div class="image-viewer-controls-bar">
      <button class="image-control-button" id="zoomInBtn" onclick="zoomIn()">+</button>
      <button class="image-control-button" id="zoomOutBtn" onclick="zoomOut()">-</button>
      <button class="image-control-button" id="resetZoomBtn" onclick="resetZoom()">é‡ç½®</button>
      <button class="image-control-button" id="rotateBtn" onclick="rotateImage()">â†»</button>
    </div>
  </div>

<script>
let ws = null;
let currentUser = null;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
let reconnectTimer = null;
// æ·»åŠ ä¸€ä¸ªå˜é‡æ¥è·Ÿè¸ªæœ€åå‘é€çš„æ¶ˆæ¯
let lastSentMessage = { content: null, timestamp: 0 };

// è§†é¢‘æ’­æ”¾å™¨ç›¸å…³å˜é‡
let videoPlayer = null;
let isVideoPlaying = false;
let videoProgressInterval = null;

// å›¾ç‰‡æŸ¥çœ‹å™¨ç›¸å…³å˜é‡
let currentImageIndex = 0;
let imageList = [];
let currentZoom = 1;
let currentRotation = 0;

function escapeHtml(str) {
  if (!str) return '';
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// æ£€æµ‹å¹¶è½¬æ¢URLä¸ºå¯ç‚¹å‡»é“¾æ¥
function detectUrls(text) {
  // URLæ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…http://ã€https://å¼€å¤´çš„URL
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  
  // å°†æ–‡æœ¬åˆ†å‰²æˆURLå’ŒéURLéƒ¨åˆ†
  const parts = text.split(urlRegex);
  
  // å¦‚æœåªæœ‰ä¸€ä¸ªéƒ¨åˆ†ï¼Œè¯´æ˜æ²¡æœ‰URL
  if (parts.length === 1) {
    return escapeHtml(text);
  }
  
  // æ„å»ºåŒ…å«é“¾æ¥çš„HTML
  let result = '';
  for (let i = 0; i < parts.length; i++) {
    if (i % 2 === 0) {
      // éURLéƒ¨åˆ†
      result += escapeHtml(parts[i]);
    } else {
      // URLéƒ¨åˆ†ï¼Œåˆ›å»ºé“¾æ¥
      const url = parts[i];
      // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡é“¾æ¥
      if (url.toLowerCase().match(/\.(jpg|jpeg|png|gif)$/)) {
        result += `<a href="javascript:void(0)" class="message-link image-link" onclick="openImageViewer('${url}')">å›¾ç‰‡</a>`;
      } 
      // æ£€æŸ¥æ˜¯å¦æ˜¯è§†é¢‘é“¾æ¥
      else if (url.toLowerCase().endsWith('.mp4')) {
        result += `<a href="javascript:void(0)" class="message-link video-link" onclick="openVideoPlayer('${url}')">è§†é¢‘</a>`;
      } 
      // å…¶ä»–URL
      else {
        result += `<a href="javascript:void(0)" class="message-link" onclick="openUrlInBrowser('${url}')">${escapeHtml(url)}</a>`;
      }
    }
  }
  
  return result;
}

// åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€URL
function openUrlInBrowser(url) {
  // ç¡®ä¿URLæœ‰åè®®å‰ç¼€
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    url = 'https://' + url;
  }
  
  // æ˜¾ç¤ºæµè§ˆå™¨é¢æ¿
  showBrowser();
  
  // å¯¼èˆªåˆ°URL
  document.getElementById('browserFrame').src = url;
}

// æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
function openImageViewer(imageUrl) {
  // ç¡®ä¿URLæœ‰åè®®å‰ç¼€
  if (!imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
    imageUrl = 'https://' + imageUrl;
  }
  
  // æ˜¾ç¤ºå›¾ç‰‡æŸ¥çœ‹å™¨
  showImageViewer();
  
  // è®¾ç½®å›¾ç‰‡æº
  const imageViewer = document.getElementById('imageViewer');
  imageViewer.src = imageUrl;
  
  // è®¾ç½®å›¾ç‰‡æ ‡é¢˜
  const imageName = imageUrl.split('/').pop() || 'å›¾ç‰‡';
  document.getElementById('imageViewerTitle').textContent = imageName;
  
  // é‡ç½®ç¼©æ”¾å’Œæ—‹è½¬
  resetImageTransform();
  
  // æ”¶é›†å½“å‰èŠå¤©ä¸­çš„æ‰€æœ‰å›¾ç‰‡
  collectImages();
  
  // è®¾ç½®å½“å‰å›¾ç‰‡ç´¢å¼•
  currentImageIndex = imageList.indexOf(imageUrl);
  if (currentImageIndex === -1) {
    currentImageIndex = 0;
  }
  
  // æ›´æ–°å¯¼èˆªæŒ‰é’®å’Œè®¡æ•°å™¨
  updateImageNavigation();
}

// æ”¶é›†èŠå¤©ä¸­çš„æ‰€æœ‰å›¾ç‰‡
function collectImages() {
  imageList = [];
  const messages = document.querySelectorAll('.chat-message');
  
  messages.forEach(message => {
    const links = message.querySelectorAll('.image-link');
    links.forEach(link => {
      // ä»onclickå±æ€§ä¸­æå–URL
      const onclickAttr = link.getAttribute('onclick');
      if (onclickAttr && onclickAttr.includes("openImageViewer('")) {
        const url = onclickAttr.match(/openImageViewer\('([^']+)'\)/)[1];
        if (url && !imageList.includes(url)) {
          imageList.push(url);
        }
      }
    });
  });
}

// æ›´æ–°å›¾ç‰‡å¯¼èˆª
function updateImageNavigation() {
  const prevBtn = document.getElementById('prevImageBtn');
  const nextBtn = document.getElementById('nextImageBtn');
  const counter = document.getElementById('imageCounter');
  
  // éšè—/æ˜¾ç¤ºå¯¼èˆªæŒ‰é’®
  prevBtn.style.display = imageList.length > 1 ? 'flex' : 'none';
  nextBtn.style.display = imageList.length > 1 ? 'flex' : 'none';
  
  // æ›´æ–°è®¡æ•°å™¨
  counter.textContent = `${currentImageIndex + 1} / ${imageList.length}`;
  counter.style.display = imageList.length > 1 ? 'block' : 'none';
  
  // ç¦ç”¨è¾¹ç•ŒæŒ‰é’®
  prevBtn.disabled = currentImageIndex === 0;
  nextBtn.disabled = currentImageIndex === imageList.length - 1;
}

// ä¸Šä¸€å¼ å›¾ç‰‡
function prevImage() {
  if (currentImageIndex > 0) {
    currentImageIndex--;
    const imageViewer = document.getElementById('imageViewer');
    imageViewer.src = imageList[currentImageIndex];
    
    // é‡ç½®ç¼©æ”¾å’Œæ—‹è½¬
    resetImageTransform();
    
    // æ›´æ–°å¯¼èˆª
    updateImageNavigation();
  }
}

// ä¸‹ä¸€å¼ å›¾ç‰‡
function nextImage() {
  if (currentImageIndex < imageList.length - 1) {
    currentImageIndex++;
    const imageViewer = document.getElementById('imageViewer');
    imageViewer.src = imageList[currentImageIndex];
    
    // é‡ç½®ç¼©æ”¾å’Œæ—‹è½¬
    resetImageTransform();
    
    // æ›´æ–°å¯¼èˆª
    updateImageNavigation();
  }
}

// é‡ç½®å›¾ç‰‡å˜æ¢
function resetImageTransform() {
  currentZoom = 1;
  currentRotation = 0;
  const imageViewer = document.getElementById('imageViewer');
  imageViewer.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
}

// æ”¾å¤§å›¾ç‰‡
function zoomIn() {
  currentZoom += 0.2;
  const imageViewer = document.getElementById('imageViewer');
  imageViewer.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
}

// ç¼©å°å›¾ç‰‡
function zoomOut() {
  if (currentZoom > 0.4) {
    currentZoom -= 0.2;
    const imageViewer = document.getElementById('imageViewer');
    imageViewer.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
  }
}

// æ—‹è½¬å›¾ç‰‡
function rotateImage() {
  currentRotation += 90;
  const imageViewer = document.getElementById('imageViewer');
  imageViewer.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
}

// æ˜¾ç¤ºå›¾ç‰‡æŸ¥çœ‹å™¨
function showImageViewer() {
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('settingsPanel').style.display = 'none';
  document.getElementById('uploadPanel').style.display = 'none';
  document.getElementById('browserPanel').style.display = 'none';
  document.getElementById('videoPlayerPanel').style.display = 'none';
  document.getElementById('imageViewerPanel').style.display = 'flex';
}

// éšè—å›¾ç‰‡æŸ¥çœ‹å™¨
function hideImageViewer() {
  document.getElementById('imageViewerPanel').style.display = 'none';
  document.getElementById('chatPanel').style.display = 'flex';
}

// æ‰“å¼€è§†é¢‘æ’­æ”¾å™¨
function openVideoPlayer(videoUrl) {
  // ç¡®ä¿URLæœ‰åè®®å‰ç¼€
  if (!videoUrl.startsWith('http://') && !videoUrl.startsWith('https://')) {
    videoUrl = 'https://' + videoUrl;
  }
  
  // æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨
  showVideoPlayer();
  
  // è®¾ç½®è§†é¢‘æº
  videoPlayer = document.getElementById('videoPlayer');
  videoPlayer.src = videoUrl;
  
  // è®¾ç½®è§†é¢‘æ ‡é¢˜
  const videoName = videoUrl.split('/').pop() || 'è§†é¢‘';
  document.getElementById('videoPlayerTitle').textContent = videoName;
  
  // æ·»åŠ è§†é¢‘äº‹ä»¶ç›‘å¬å™¨
  setupVideoPlayerEvents();
}

// è®¾ç½®è§†é¢‘æ’­æ”¾å™¨äº‹ä»¶
function setupVideoPlayerEvents() {
  if (!videoPlayer) return;
  
  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
  if (videoProgressInterval) {
    clearInterval(videoProgressInterval);
  }
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
  videoPlayer.addEventListener('loadedmetadata', function() {
    updateVideoTimeDisplay();
  });
  
  videoPlayer.addEventListener('timeupdate', function() {
    updateVideoProgress();
    updateVideoTimeDisplay();
  });
  
  videoPlayer.addEventListener('play', function() {
    isVideoPlaying = true;
    document.getElementById('playPauseBtn').textContent = 'âšâš';
  });
  
  videoPlayer.addEventListener('pause', function() {
    isVideoPlaying = false;
    document.getElementById('playPauseBtn').textContent = 'â–¶';
  });
  
  videoPlayer.addEventListener('ended', function() {
    isVideoPlaying = false;
    document.getElementById('playPauseBtn').textContent = 'â–¶';
  });
  
  // è®¾ç½®è¿›åº¦æ¡ç‚¹å‡»äº‹ä»¶
  document.getElementById('progressBarContainer').addEventListener('click', function(e) {
    const rect = this.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    videoPlayer.currentTime = percent * videoPlayer.duration;
  });
  
  // è®¾ç½®éŸ³é‡æ»‘å—ç‚¹å‡»äº‹ä»¶
  document.getElementById('volumeSlider').addEventListener('click', function(e) {
    const rect = this.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    videoPlayer.volume = percent;
    updateVolumeDisplay();
  });
  
  // è®¾ç½®æ’­æ”¾/æš‚åœæŒ‰é’®
  document.getElementById('playPauseBtn').addEventListener('click', function() {
    if (isVideoPlaying) {
      videoPlayer.pause();
    } else {
      videoPlayer.play();
    }
  });
  
  // è®¾ç½®éŸ³é‡æŒ‰é’®
  document.getElementById('volumeBtn').addEventListener('click', function() {
    if (videoPlayer.volume > 0) {
      videoPlayer.volume = 0;
      this.textContent = 'ğŸ”‡';
    } else {
      videoPlayer.volume = 1;
      this.textContent = 'ğŸ”Š';
    }
    updateVolumeDisplay();
  });
  
  // è®¾ç½®å…¨å±æŒ‰é’®
  document.getElementById('fullscreenBtn').addEventListener('click', function() {
    if (videoPlayer.requestFullscreen) {
      videoPlayer.requestFullscreen();
    } else if (videoPlayer.mozRequestFullScreen) {
      videoPlayer.mozRequestFullScreen();
    } else if (videoPlayer.webkitRequestFullscreen) {
      videoPlayer.webkitRequestFullscreen();
    } else if (videoPlayer.msRequestFullscreen) {
      videoPlayer.msRequestFullscreen();
    }
  });
  
  // åˆå§‹åŒ–éŸ³é‡æ˜¾ç¤º
  updateVolumeDisplay();
}

// æ›´æ–°è§†é¢‘è¿›åº¦æ¡
function updateVideoProgress() {
  if (!videoPlayer) return;
  
  const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
  document.getElementById('videoProgress').style.width = progress + '%';
}

// æ›´æ–°è§†é¢‘æ—¶é—´æ˜¾ç¤º
function updateVideoTimeDisplay() {
  if (!videoPlayer) return;
  
  const currentTime = formatTime(videoPlayer.currentTime);
  const duration = formatTime(videoPlayer.duration);
  document.getElementById('videoTime').textContent = `${currentTime} / ${duration}`;
}

// æ›´æ–°éŸ³é‡æ˜¾ç¤º
function updateVolumeDisplay() {
  if (!videoPlayer) return;
  
  const volume = videoPlayer.volume;
  document.getElementById('volumeLevel').style.width = (volume * 100) + '%';
  
  // æ›´æ–°éŸ³é‡å›¾æ ‡
  const volumeBtn = document.getElementById('volumeBtn');
  if (volume === 0) {
    volumeBtn.textContent = 'ğŸ”‡';
  } else if (volume < 0.5) {
    volumeBtn.textContent = 'ğŸ”ˆ';
  } else {
    volumeBtn.textContent = 'ğŸ”Š';
  }
}

// æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’ -> åˆ†:ç§’ï¼‰
function formatTime(seconds) {
  if (isNaN(seconds)) return '0:00';
  
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

// æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨
function showVideoPlayer() {
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('settingsPanel').style.display = 'none';
  document.getElementById('uploadPanel').style.display = 'none';
  document.getElementById('browserPanel').style.display = 'none';
  document.getElementById('imageViewerPanel').style.display = 'none';
  document.getElementById('videoPlayerPanel').style.display = 'flex';
}

// éšè—è§†é¢‘æ’­æ”¾å™¨
function hideVideoPlayer() {
  if (videoPlayer) {
    videoPlayer.pause();
    videoPlayer.src = '';
  }
  
  document.getElementById('videoPlayerPanel').style.display = 'none';
  document.getElementById('chatPanel').style.display = 'flex';
}

// æ˜¾ç¤ºæµè§ˆå™¨é¢æ¿
function showBrowser() {
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('settingsPanel').style.display = 'none';
  document.getElementById('uploadPanel').style.display = 'none';
  document.getElementById('videoPlayerPanel').style.display = 'none';
  document.getElementById('imageViewerPanel').style.display = 'none';
  document.getElementById('browserPanel').style.display = 'flex';
}

// éšè—æµè§ˆå™¨é¢æ¿
function hideBrowser() {
  document.getElementById('browserPanel').style.display = 'none';
  document.getElementById('chatPanel').style.display = 'flex';
}

// æµè§ˆå™¨å¯¼èˆªåŠŸèƒ½
function navigateToUrl() {
  let url = document.getElementById('browserAddress').value.trim();
  
  if (!url) return;
  
  // ç¡®ä¿URLæœ‰åè®®å‰ç¼€
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    url = 'https://' + url;
  }
  
  document.getElementById('browserFrame').src = url;
}

// æµè§ˆå™¨åé€€
function browserBack() {
  try {
    document.getElementById('browserFrame').contentWindow.history.back();
  } catch (e) {
    console.error('æ— æ³•åé€€:', e);
  }
}

// æµè§ˆå™¨å‰è¿›
function browserForward() {
  try {
    document.getElementById('browserFrame').contentWindow.history.forward();
  } catch (e) {
    console.error('æ— æ³•å‰è¿›:', e);
  }
}

// æµè§ˆå™¨åˆ·æ–°
function browserReload() {
  document.getElementById('browserFrame').src = document.getElementById('browserFrame').src;
}

// æ˜¾ç¤ºä¸Šä¼ é¢æ¿
function showUpload() {
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('settingsPanel').style.display = 'none';
  document.getElementById('browserPanel').style.display = 'none';
  document.getElementById('videoPlayerPanel').style.display = 'none';
  document.getElementById('imageViewerPanel').style.display = 'none';
  document.getElementById('uploadPanel').style.display = 'flex';
}

// éšè—ä¸Šä¼ é¢æ¿
function hideUpload() {
  document.getElementById('uploadPanel').style.display = 'none';
  document.getElementById('chatPanel').style.display = 'flex';
}

// æ–‡ä»¶é¢„è§ˆ
function previewFile() {
  const fileInput = document.getElementById('fileInput');
  const filePreview = document.getElementById('filePreview');
  const uploadBtn = document.getElementById('uploadBtn');
  
  if (fileInput.files && fileInput.files[0]) {
    const file = fileInput.files[0];
    const fileType = file.type;
    
    // éªŒè¯æ–‡ä»¶ç±»å‹
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'video/mp4'];
    if (!allowedTypes.includes(fileType)) {
      alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·é€‰æ‹©å›¾ç‰‡(JPG, JPEG, PNG, GIF)æˆ–è§†é¢‘(MP4)æ–‡ä»¶ã€‚');
      fileInput.value = '';
      filePreview.style.display = 'none';
      uploadBtn.disabled = true;
      return;
    }
    
    // éªŒè¯æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º500MB)
    const maxSize = 500 * 1024 * 1024; // 500MB
    if (file.size > maxSize) {
      alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡500MBã€‚');
      fileInput.value = '';
      filePreview.style.display = 'none';
      uploadBtn.disabled = true;
      return;
    }
    
    // æ˜¾ç¤ºé¢„è§ˆ
    filePreview.style.display = 'block';
    
    if (fileType.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(e) {
        filePreview.innerHTML = `<img src="${e.target.result}" alt="é¢„è§ˆ">`;
      };
      reader.readAsDataURL(file);
    } else if (fileType === 'video/mp4') {
      const reader = new FileReader();
      reader.onload = function(e) {
        filePreview.innerHTML = `<video controls><source src="${e.target.result}" type="video/mp4">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘é¢„è§ˆã€‚</video>`;
      };
      reader.readAsDataURL(file);
    }
    
    uploadBtn.disabled = false;
  } else {
    filePreview.style.display = 'none';
    uploadBtn.disabled = true;
  }
}

// ä¸Šä¼ æ–‡ä»¶
function uploadFile() {
  const fileInput = document.getElementById('fileInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');
  
  if (!fileInput.files || !fileInput.files[0]) {
    alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
    return;
  }
  
  const file = fileInput.files[0];
  const formData = new FormData();
  formData.append('file', file);
  
  // æ˜¾ç¤ºè¿›åº¦æ¡
  progressContainer.style.display = 'block';
  uploadBtn.disabled = true;
  uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';
  
  // åˆ›å»ºXMLHttpRequestå¯¹è±¡
  const xhr = new XMLHttpRequest();
  
  // ç›‘å¬ä¸Šä¼ è¿›åº¦
  xhr.upload.addEventListener('progress', function(e) {
    if (e.lengthComputable) {
      const percentComplete = (e.loaded / e.total) * 100;
      progressBar.style.width = percentComplete + '%';
      progressText.textContent = Math.round(percentComplete) + '%';
    }
  });
  
  // ç›‘å¬ä¸Šä¼ å®Œæˆ
  xhr.addEventListener('load', function() {
    if (xhr.status === 200) {
      const response = JSON.parse(xhr.responseText);
      if (response.success) {
        // ä¸Šä¼ æˆåŠŸï¼Œå‘é€æ–‡ä»¶é“¾æ¥åˆ°èŠå¤©
        const fileUrl = `http://127.0.01:8082/${response.filename}`;
        
        // å¦‚æœWebSocketè¿æ¥æ­£å¸¸ï¼Œé€šè¿‡WebSocketå‘é€æ¶ˆæ¯
        if (ws && ws.readyState === WebSocket.OPEN) {
          const timestamp = new Date().getTime();
          lastSentMessage = { content: fileUrl, timestamp: timestamp };
          
          ws.send(JSON.stringify({
            type: 'message',
            content: fileUrl
          }));
          
          // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
          saveMessageToLocalStorage(currentUser, fileUrl, timestamp);
          appendMessage(currentUser, fileUrl, timestamp);
        } else {
          // å¦‚æœæ²¡æœ‰WebSocketè¿æ¥ï¼Œç›´æ¥æ·»åŠ åˆ°èŠå¤©ç•Œé¢
          const timestamp = new Date().getTime();
          saveMessageToLocalStorage(currentUser, fileUrl, timestamp);
          appendMessage(currentUser, fileUrl, timestamp);
        }
        
        // é‡ç½®ä¸Šä¼ è¡¨å•
        fileInput.value = '';
        document.getElementById('filePreview').style.display = 'none';
        progressContainer.style.display = 'none';
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'ä¸Šä¼ æ–‡ä»¶';
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼');
        
        // è¿”å›èŠå¤©ç•Œé¢
        hideUpload();
      } else {
        alert('ä¸Šä¼ å¤±è´¥: ' + response.message);
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'ä¸Šä¼ æ–‡ä»¶';
      }
    } else {
      alert('ä¸Šä¼ å¤±è´¥ï¼ŒæœåŠ¡å™¨é”™è¯¯: ' + xhr.status);
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'ä¸Šä¼ æ–‡ä»¶';
    }
  });
  
  // ç›‘å¬ä¸Šä¼ é”™è¯¯
  xhr.addEventListener('error', function() {
    alert('ä¸Šä¼ å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯');
    uploadBtn.disabled = false;
    uploadBtn.textContent = 'ä¸Šä¼ æ–‡ä»¶';
  });
  
  // å‘é€è¯·æ±‚
  xhr.open('POST', 'http://127.0.0.1:8082/upload');
  xhr.send(formData);
}

// åˆå§‹åŒ–é¡µé¢
document.addEventListener('DOMContentLoaded', function() {
  const savedUser = localStorage.getItem('jfchat_user');
  const rememberMe = localStorage.getItem('jfchat_remember') !== 'false';
  
  // è®¾ç½®è®°ä½ç™»å½•çŠ¶æ€å¤é€‰æ¡†
  document.getElementById('rememberMe').checked = rememberMe;
  
  // åŠ è½½è®¾ç½®
  loadSettings();
  
  // å®‰å“æ–‡ä»¶é€‰æ‹©å™¨ä¼˜åŒ–
  const fileInput = document.getElementById('fileInput');
  if (fileInput) {
    fileInput.addEventListener('change', previewFile);
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿åœ¨å®‰å“è®¾å¤‡ä¸Šä¹Ÿèƒ½æ­£å¸¸è§¦å‘æ–‡ä»¶é€‰æ‹©
    const fileInputLabel = document.querySelector('.file-input-label');
    if (fileInputLabel) {
      fileInputLabel.addEventListener('click', function(e) {
        // é˜²æ­¢äº‹ä»¶å†’æ³¡
        e.stopPropagation();
      });
    }
  }
  
  if (savedUser && rememberMe) {
    try {
      const { username, password } = JSON.parse(savedUser);
      document.getElementById('username').value = username;
      document.getElementById('password').value = password;

      // å»¶è¿Ÿè‡ªåŠ¨ç™»å½•ï¼Œè®©ç”¨æˆ·æœ‰æœºä¼šå–æ¶ˆ
      setTimeout(() => {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»æ‰‹åŠ¨ä¿®æ”¹äº†å‡­æ®
        const currentUsername = document.getElementById('username').value;
        const currentPassword = document.getElementById('password').value;
        
        if (currentUsername === username && currentPassword === password) {
          login();
        }
      }, 500);
    } catch (e) {
      console.error('è§£æä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
      clearSavedCredentials();
    }
  }
});

// ç™»å½•åŠŸèƒ½
function login() {
  const username = escapeHtml(document.getElementById('username').value.trim());
  const password = escapeHtml(document.getElementById('password').value.trim());
  const rememberMe = document.getElementById('rememberMe').checked;
  const loginBtn = document.getElementById('loginBtn');
  const originalBtnText = loginBtn.textContent;

  if (!username || !password) {
    alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
    return;
  }

  loginBtn.textContent = 'ç™»å½•ä¸­...';
  loginBtn.disabled = true;

  const saveCredentials = () => {
    if (rememberMe) {
      localStorage.setItem('jfchat_user', JSON.stringify({ username, password }));
      localStorage.setItem('jfchat_remember', 'true');
    } else {
      clearSavedCredentials();
    }
  };

  reconnectAttempts = 0;
  clearReconnectTimer();

  document.getElementById('reconnectAlert').style.display = 'none';

  if (ws) {
    ws.close();
    ws = null;
  }

  ws = new WebSocket('ws://127.0.0.1:8081');
  
  ws.onopen = () => {
    ws.send(JSON.stringify({
      action: 'login',
      username: username,
      password: password
    }));
  };

  ws.onmessage = (e) => {
    const data = tryParseJson(e.data);
    if (data) {
      if (data.success !== undefined) {

        loginBtn.textContent = originalBtnText;
        loginBtn.disabled = false;
        
        if (data.success) {
          saveCredentials();
          currentUser = username;
          document.getElementById('loginPanel').style.display = 'none';
          document.getElementById('chatPanel').style.display = 'flex';
          document.getElementById('currentUsername').textContent = username;
          document.getElementById('reconnectAlert').style.display = 'none';
          
          // åŠ è½½æœ¬åœ°å­˜å‚¨çš„èŠå¤©è®°å½•
          loadLocalMessages();
        } else {
          if (!rememberMe) {
            clearSavedCredentials();
          }
          alert(data.message || 'ç™»å½•å¤±è´¥');
        }
      } else if (data.type === 'message') {
        // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œå¦‚æœæ˜¯åˆ™å¿½ç•¥
        if (data.sender === currentUser && 
            data.content === lastSentMessage.content &&
            Math.abs(data.timestamp - lastSentMessage.timestamp) < 1000) {
          // è¿™æ˜¯å½“å‰ç”¨æˆ·åˆšåˆšå‘é€çš„æ¶ˆæ¯ï¼Œå¿½ç•¥å®ƒ
          lastSentMessage = { content: null, timestamp: 0 }; // é‡ç½®
          return;
        }
        appendMessage(data.sender, data.content, data.timestamp);
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        saveMessageToLocalStorage(data.sender, data.content, data.timestamp);
      } else if (data.type === 'offline-messages') {
        // åªä¿å­˜ç¦»çº¿æ¶ˆæ¯åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä¸æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢
        data.messages.sort((a, b) => a.timestamp - b.timestamp);
        data.messages.forEach(msg => {
          // åªä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä¸æ˜¾ç¤º
          saveMessageToLocalStorage(msg.sender, msg.content, msg.timestamp);
        });
        
        // æ·»åŠ ç³»ç»Ÿæç¤ºæ¶ˆæ¯
        const systemMsg = document.createElement('div');
        systemMsg.className = 'system-message';
        systemMsg.textContent = 'å·²åŠ è½½ç¦»çº¿æ¶ˆæ¯';
        document.getElementById('messageContainer').appendChild(systemMsg);
      }
    }
  };

  ws.onerror = (e) => {
    console.error('è¿æ¥é”™è¯¯:', e);
    loginBtn.textContent = originalBtnText;
    loginBtn.disabled = false;
    
    if (!rememberMe) {
      clearSavedCredentials();
    }
    handleConnectionError();
  };
  
  ws.onclose = () => {
    if (currentUser) {
      handleConnectionError();
    }
  };
}

// æ¸…é™¤ä¿å­˜çš„å‡­æ®
function clearSavedCredentials() {
  localStorage.removeItem('jfchat_user');
  localStorage.removeItem('jfchat_remember');
}

// å‘é€æ¶ˆæ¯
function sendMessage() {
  const input = document.getElementById('messageInput');
  let message = input.value.trim();
  
  if (!message || !ws || ws.readyState !== WebSocket.OPEN) return;
  
  message = escapeHtml(message);
  
  // è®°å½•æœ€åå‘é€çš„æ¶ˆæ¯
  const timestamp = new Date().getTime();
  lastSentMessage = { content: message, timestamp: timestamp };
  
  ws.send(JSON.stringify({
    type: 'message',
    content: message
  }));
  
  // å³ä½¿æ²¡æœ‰ç½‘ç»œä¹Ÿä¿å­˜åˆ°æœ¬åœ°
  saveMessageToLocalStorage(currentUser, message, timestamp);
  appendMessage(currentUser, message, timestamp);
  
  input.value = '';
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
function appendMessage(sender, content, timestamp) {
  const container = document.getElementById('messageContainer');
  const isSelf = sender === currentUser;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${isSelf ? 'own-message' : 'other-message'}`;
  messageDiv.dataset.timestamp = timestamp;

  let htmlContent = '';
  if (!isSelf) {
    htmlContent += `<span class="username">${escapeHtml(sender)}</span>`;
  }
  htmlContent += `<div class="${isSelf ? 'own-text' : 'other-text'}">`;
  // ä½¿ç”¨detectUrlså‡½æ•°å¤„ç†å†…å®¹ï¼Œå°†URLè½¬æ¢ä¸ºå¯ç‚¹å‡»é“¾æ¥
  htmlContent += detectUrls(content);
  htmlContent += '</div>';

  messageDiv.innerHTML = htmlContent;

  let inserted = false;
  const messages = container.querySelectorAll('.chat-message');
  for (let i = 0; i < messages.length; i++) {
    const msgTimestamp = messages[i].dataset.timestamp || 0;
    if (timestamp < msgTimestamp) {
      container.insertBefore(messageDiv, messages[i]);
      inserted = true;
      break;
    }
  }
  
  if (!inserted) {
    container.appendChild(messageDiv);
  }
  
  container.scrollTop = container.scrollHeight;
}

// ä¿å­˜æ¶ˆæ¯åˆ°æœ¬åœ°å­˜å‚¨
function saveMessageToLocalStorage(sender, content, timestamp) {
  try {
    // è·å–ç°æœ‰æ¶ˆæ¯
    const storedMessages = JSON.parse(localStorage.getItem('jfchat_messages') || '[]');
    
    // æ·»åŠ æ–°æ¶ˆæ¯
    storedMessages.push({
      sender,
      content,
      timestamp
    });
    
    // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
    localStorage.setItem('jfchat_messages', JSON.stringify(storedMessages));
  } catch (e) {
    console.error('ä¿å­˜æ¶ˆæ¯åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
  }
}

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¶ˆæ¯
function loadLocalMessages() {
  try {
    const storedMessages = JSON.parse(localStorage.getItem('jfchat_messages') || '[]');
    
    if (storedMessages.length > 0) {
      // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯æç¤º
      const systemMsg = document.createElement('div');
      systemMsg.className = 'system-message';
      systemMsg.textContent = 'å·²åŠ è½½æœ¬åœ°èŠå¤©è®°å½•';
      document.getElementById('messageContainer').appendChild(systemMsg);
      
      // æŒ‰æ—¶é—´æ’åº
      storedMessages.sort((a, b) => a.timestamp - b.timestamp);
      
      // æ˜¾ç¤ºæ¶ˆæ¯
      storedMessages.forEach(msg => {
        appendMessage(msg.sender, msg.content, msg.timestamp);
      });
    }
  } catch (e) {
    console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¶ˆæ¯å¤±è´¥:', e);
  }
}

// æ˜¾ç¤ºè®¾ç½®é¢æ¿
function showSettings() {
  document.getElementById('chatPanel').style.display = 'none';
  document.getElementById('settingsPanel').style.display = 'flex';
  document.getElementById('uploadPanel').style.display = 'none';
  document.getElementById('browserPanel').style.display = 'none';
  document.getElementById('videoPlayerPanel').style.display = 'none';
  document.getElementById('imageViewerPanel').style.display = 'none';
}

// éšè—è®¾ç½®é¢æ¿
function hideSettings() {
  document.getElementById('settingsPanel').style.display = 'none';
  document.getElementById('chatPanel').style.display = 'flex';
}

// åŠ è½½è®¾ç½®
function loadSettings() {
  try {
    const settings = JSON.parse(localStorage.getItem('jfchat_settings') || '{}');
    
    // ç•Œé¢è®¾ç½®
    document.getElementById('themeSelect').value = settings.theme || 'light';
    document.getElementById('fontSize').value = settings.fontSize || 'medium';
    
    // åº”ç”¨è®¾ç½®
    applyTheme(settings.theme || 'light');
    applyFontSize(settings.fontSize || 'medium');
  } catch (e) {
    console.error('åŠ è½½è®¾ç½®å¤±è´¥:', e);
  }
}

// ä¿å­˜è®¾ç½®
function saveSettings() {
  try {
    const settings = {
      // ç•Œé¢è®¾ç½®
      theme: document.getElementById('themeSelect').value,
      fontSize: document.getElementById('fontSize').value
    };
    
    localStorage.setItem('jfchat_settings', JSON.stringify(settings));
    
    // åº”ç”¨è®¾ç½®
    applyTheme(settings.theme);
    applyFontSize(settings.fontSize);
    
    alert('è®¾ç½®å·²ä¿å­˜');
    hideSettings();
  } catch (e) {
    console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', e);
    alert('ä¿å­˜è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// åº”ç”¨ä¸»é¢˜
function applyTheme(theme) {
  const body = document.body;
  
  // ç§»é™¤ç°æœ‰ä¸»é¢˜ç±»
  body.classList.remove('theme-light', 'theme-dark');
  
  // åº”ç”¨æ–°ä¸»é¢˜
  if (theme === 'dark') {
    body.classList.add('theme-dark');
  } else if (theme === 'light') {
    body.classList.add('theme-light');
  } else if (theme === 'auto') {
    // è·Ÿéšç³»ç»Ÿ
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      body.classList.add('theme-dark');
    } else {
      body.classList.add('theme-light');
    }
  }
}

// åº”ç”¨å­—ä½“å¤§å°
function applyFontSize(fontSize) {
  const body = document.body;
  
  // ç§»é™¤ç°æœ‰å­—ä½“å¤§å°ç±»
  body.classList.remove('font-small', 'font-medium', 'font-large');
  
  // åº”ç”¨æ–°å­—ä½“å¤§å°
  body.classList.add(`font-${fontSize}`);
}

// ç¡®è®¤æ¸…é™¤èŠå¤©è®°å½•
function confirmClearChatHistory() {
  if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
    clearChatHistory();
  }
}

// æ¸…é™¤èŠå¤©è®°å½•
function clearChatHistory() {
  try {
    // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„èŠå¤©è®°å½•
    localStorage.removeItem('jfchat_messages');
    
    // æ¸…é™¤èŠå¤©ç•Œé¢
    document.getElementById('messageContainer').innerHTML = '';
    
    // æ·»åŠ ç³»ç»Ÿæç¤ºæ¶ˆæ¯
    const systemMsg = document.createElement('div');
    systemMsg.className = 'system-message';
    systemMsg.textContent = 'èŠå¤©è®°å½•å·²æ¸…ç©º';
    document.getElementById('messageContainer').appendChild(systemMsg);
    
    alert('èŠå¤©è®°å½•å·²æˆåŠŸåˆ é™¤');
  } catch (e) {
    console.error('æ¸…é™¤èŠå¤©è®°å½•å¤±è´¥:', e);
    alert('æ¸…é™¤èŠå¤©è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// é€€å‡ºç™»å½•
function logout() {
  if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
    // å…³é—­WebSocketè¿æ¥
    if (ws) {
      ws.close();
      ws = null;
    }
    
    // æ¸…é™¤å½“å‰ç”¨æˆ·
    currentUser = null;
    
    // æ˜¾ç¤ºç™»å½•é¢æ¿
    document.getElementById('settingsPanel').style.display = 'none';
    document.getElementById('chatPanel').style.display = 'none';
    document.getElementById('browserPanel').style.display = 'none';
    document.getElementById('uploadPanel').style.display = 'none';
    document.getElementById('videoPlayerPanel').style.display = 'none';
    document.getElementById('imageViewerPanel').style.display = 'none';
    document.getElementById('loginPanel').style.display = 'block';
    
    // æ¸…é™¤èŠå¤©æ¶ˆæ¯
    document.getElementById('messageContainer').innerHTML = '';
    
    // æ¸…é™¤ä¿å­˜çš„å‡­æ®
    clearSavedCredentials();
  }
}

function tryParseJson(str) {
  try { 
    return JSON.parse(str);
  } catch (e) {
    console.error('è§£æJSONå¤±è´¥:', e, 'åŸå§‹æ•°æ®:', str);
    return null;
  }
}

function handleConnectionError() {
  if (reconnectAttempts < maxReconnectAttempts) {
    reconnectAttempts++;
    document.getElementById('attemptCount').textContent = reconnectAttempts;
    document.getElementById('reconnectAlert').style.display = 'block';
    
    clearReconnectTimer();
    reconnectTimer = setTimeout(() => {
      login();
    }, 3000);
  } else {
    document.getElementById('reconnectAlert').className = 'error';
    document.getElementById('reconnectAlert').innerHTML = 
      'è¿æ¥å¤±è´¥ï¼Œè¯·<a href="javascript:location.reload()">åˆ·æ–°é¡µé¢</a>é‡è¯•';
  }
}

function clearReconnectTimer() {
  if (reconnectTimer) {
    clearTimeout(reconnectTimer);
    reconnectTimer = null;
  }
}
</script>
</body>
</html>